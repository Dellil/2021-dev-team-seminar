제가 발표할 것은 리팩터링 1챕터에 대해 제가 공부한 것입니다.

우선, 1챕터는 리팩터링에 관한 이론적 설명은 하나도 나오지 않습니다. 왜냐하면 이론을 먼저 집어넣으면 몰입도가 떨어지고 집중이 잘 안된다고 저자가 말했기때문입니다.

그래서 리팩터링의 구체적 정의는 무엇인지, 코드 스멜이 무엇인지, 리팩터링 기법에는 어떤 것들이 있는지에 관한 이론 설명은 없습니다.

대신에 리팩터링을 한다는 것은 어떤건지, 리팩터링의 리듬(프로세스)은 어떻게 되는지 직감적으로 이해를 할 수 있게 해줍니다.

정리를 하자면 1챕터는 리팩터링을 맛보는 챕터로 파울러 아저씨가 만든 프로그램과 함께 하게 됩니다.

그래서 저는 이 프로그램을 리팩토링하는 과정과 그 과정속에서 배우고 익힌 것들을 중심으로 이번 세미나를 진행하도록 하겠습니다. 또한 도중에 리팩토링 기법을 쓸때 왜 이런 기법을 썼는지에 대해서는 그 기법을 설명하는 시간때 다시 얘기를 꺼내겠습니다.

파울러 아저씨가 만든 예제용 프로그램은 공연료 내역서를 출력하는 프로그램입니다.

더 정확히 말하자면 '다양한 연극을 외주로 받아 공연하는 극단이 있는데, 연극 장르와 관객 규모를 기초로 비용을 정합니다. 현재 이 극단은 비극과 희극만 공연하고, 공연료와는 별개로 포인트라는 것을 지급해, 다음 의뢰에 공연료를 할인받게 해주는 프로그램'입니다.

데이터셋입니다. 데이터셋은 청구서와 연극에 관한 데이터들이 들어있습니다.

리팩토리전 전체 코드입니다.

statement()라는 함수에 데이터셋을 집어넣으면 공연료 내역서가 출력이 됩니다.

총액은 totalAmount, 적립 포인트는 volumeCredits, 출력할 문자열은 result라는 변수를 쓰고 있고, 달러 표시를 해주기 위해 포맷터 변수를 만들어 사용합니다.

for문을 돌면서 thisAmount로 연극 하나의 금액을 구하고 이를 totalAmount에 더해 주는 방식으로 금액을 계산하고 있고, 연극 장르와 관객규모에 따라 금액이 달라집니다.

이 함수 하나만 놓고보면 엄청 나쁜 코드는 아니라는 생각이 듭니다. 하지만 저희가 작업하고 있는 코드베이스는 엄청난 라인 수를 가지고 있습니다. 때문에 좀 더 깔끔한 형태를 할 필요가 있습니다. (모두의 생산성을 위해)

그리고 이 함수는 요청사항이 들어오면 더욱 더 복잡해질 것입니다. 다음과 같은 요청사항이 들어온다면 어떻게 될까요?

1. HTML로 출력하는 기능이 필요해요! (여러 형태로 출력하는 기능이 있을 수 있음)
2. 향후 여러 장르를 선택할 수 있어야됨 (공연료, 적립 포인트 계산법에 영향 줌)

뭔가 고통받는 개발자의 모습이 보이지 않나요?

파울러 아저씨가 말씀하시길 "요청사항은 수색대원처람 한 둘 오는게 아닌 부대단위로 우르르 온다" 라구요.

또한, 우리가 소프트웨어를 만든다는건, 서비스를 만든다는 건 결국 고객을 위해서입니다. 우리를 필요로하는 사람들을 위해 우리는 우리의 코드를 깔끔하게 만들 의무가 있습니다.

그래서 우선 이 함수를 기능을 구현하기 편한 형태로 고친 다음 앞서 위의 요청사항들을 구현을 해볼것입니다.

---

### 기능을 추가하기 쉬운 형태로 리팩터링 하기

리팩터링에 앞서 먼저 해야될건 테스트 코드를 준비하는 것입니다. 파울러 선생님이 테스트를 돌리며 리팩터링을 하는게 중요하다고 했지만, 지금은 가벼운 예제 프로그램이라 따로 작성은 하지 않았습니다.

우선 맨 처음으로 할 건 statement() 함수를 쪼개는 것입니다.

전체 동작을 각각 나눌 수 있는 지점을 찾고 쪼개버립니다.

그 과정에서, 로컬변수는 최대한 다 없애버립니다. (`변수 인라인`(함수의 결괏값을 변수에 선언해서 사용하는 것이 아닌 실제 쓰이는 곳에 함수를 박아넣은 것) 기법을 사용했는데 이에 대한 자세한 건 챕터6에서 나옵니다.)

결과물을 보면 출력하는 코드는 result 변수를 제외한 각각의 함수들이 있습니다.
처음 한개 for문에 여러 로직이 있던 걸 각각의 for문에 각각의 로직을 담았습니다. (totalAmount, totalVolumeCredits이 그 예시)

---

위의 코드를 보니까 뭔가 감이 오지 않으신가요? 그렇습니다. 데이터를 처리하면서 나온 것들을 plain text로 포맷팅해주고 있습니다. 그래서 파울러 선생님은 이 두 단계를 직접 분리하면서 html로 렌더링해주는 기능도 구현하기로 했습니다.

아래 코드는 계산 단계와 포맷팅 단계를 분리하며 생긴 두 파일들의 코드입니다.

(함수 호출 순서대로 코드 읊어주기)

---

### 연극 장르 추가와 계산 단계 코드 재구성

마지막으로 구현할 것은 연극 장르 추가와 장르마다의 계산법을 다르게 지정하도록 기능을 추가하는 것입니다.

`조건부 로직을 다형성으로 바꿔주기` 로 기존의 amountFor함수의 스위치문으로 요금을 계산해주던걸 팩토리 메소드 형식으로 추상화시켜 요금을 계산하고 있습니다.

이렇게 함으로써 여러 장르가 추가될 때마다 간단히 넣을 수 있게 되었고, 장르마다의 가격 계산도 간단하게 이뤄질 수 있습니다.

리팩터링된 코드들은 이제 이런 것들에 대해 편하게 구현할 수 있습니다.

1. 여러 형태로 렌더링을 해줄 수 있습니다. (html, json, xml 등등, 각 출력형태에 대한 함수만 정의 해놓으면됨)
2. 여러 장르를 만들고, 그에 대한 계산도 각각 다르게 해줄 수 있습니다. (PerformanceCalculator를 상속받고 amount와 volumeCredits을 재정의 해주면 됨)
